version: '3.8'

services:
  # MQTT Broker (Eclipse Mosquitto)
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mqtt-broker
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - danube-network

  # Danube Broker (placeholder - use actual Danube setup)
  danube-broker:
    image: danube-messaging/broker:latest
    container_name: danube-broker
    ports:
      - "6650:6650"
    environment:
      ETCD_ENDPOINTS: "etcd:2379"
    depends_on:
      - etcd
    networks:
      - danube-network

  # etcd for Danube
  etcd:
    image: quay.io/coreos/etcd:latest
    container_name: etcd
    environment:
      ETCD_LISTEN_CLIENT_URLS: "http://0.0.0.0:2379"
      ETCD_ADVERTISE_CLIENT_URLS: "http://etcd:2379"
    ports:
      - "2379:2379"
    networks:
      - danube-network

  # MQTT Source Connector
  mqtt-connector:
    build:
      context: ../../
      dockerfile: connectors/source-mqtt/Dockerfile
    container_name: mqtt-source-connector
    depends_on:
      - mosquitto
      - danube-broker
    environment:
      # Danube configuration
      DANUBE_SERVICE_URL: "http://danube-broker:6650"
      CONNECTOR_NAME: "mqtt-iot-source"
      MQTT_DANUBE_TOPIC: "/iot/sensors"
      
      # MQTT configuration
      MQTT_BROKER_HOST: "mosquitto"
      MQTT_BROKER_PORT: "1883"
      MQTT_CLIENT_ID: "danube-connector-1"
      MQTT_TOPICS: "sensors/#,devices/+/telemetry"
      MQTT_QOS: "1"
      
      # Runtime
      RELIABLE_DISPATCH: "true"
      POLL_INTERVAL_MS: "100"
      
      # Logging
      LOG_LEVEL: "info"
      RUST_LOG: "info,danube_source_mqtt=debug"
    networks:
      - danube-network
    restart: unless-stopped

  # Optional: MQTT Publisher for testing
  mqtt-publisher:
    image: eclipse-mosquitto:2
    container_name: mqtt-publisher
    depends_on:
      - mosquitto
    networks:
      - danube-network
    command: >
      sh -c "
      sleep 5 &&
      while true; do
        mosquitto_pub -h mosquitto -t sensors/temp/zone1 -m '{\"value\": $$RANDOM, \"unit\": \"celsius\", \"timestamp\": $$(date +%s)}' &&
        mosquitto_pub -h mosquitto -t devices/device1/telemetry -m '{\"battery\": $$((RANDOM % 100)), \"signal\": $$((RANDOM % 100))}' &&
        sleep 5
      done
      "

networks:
  danube-network:
    driver: bridge
